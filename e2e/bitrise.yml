format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared envs for every test workflow
  - BITRISEIO_FINISHED_STAGES: |-
        [{
            "id": "e8741240-0acd-42ed-a3c4-c827d3d2db93",
            "name": "stage-1-new",
            "workflows": [{
                    "credit_cost": 2,
                    "external_id": "d686bed6-f45f-4c0f-891b-47c736d03274",
                    "finished_at": "2022-10-12T15:09:16Z",
                    "id": "e18f50d7-1908-44ca-a04e-159da6ed76ce",
                    "name": "placeholder",
                    "started_at": "2022-10-12T15:09:15Z",
                    "status": "succeeded"
                },
                {
                    "credit_cost": 2,
                    "external_id": "94ae31e3-6bd7-4bd9-a469-f0be00c0f894",
                    "finished_at": "2022-10-12T15:09:33Z",
                    "id": "e41d3e4d-7a8e-4c42-8490-db9fa5f04aa1",
                    "name": "textfile_generator-new",
                    "started_at": "2022-10-12T15:09:17Z",
                    "status": "succeeded"
                }]
            }, {
            "id": "4884b564-ea63-43cd-a19f-25e12a7c6d4f",
            "name": "stage-2-new",
            "workflows": [{
                    "credit_cost": null,
                    "external_id": "c9b11e6d-92bb-44a4-ac9a-4edc51833e7a",
                    "finished_at": "2022-10-12T15:09:52Z",
                    "id": "ffea37ad-3e67-48ab-9e87-02f171079e06",
                    "name": "deployer-new",
                    "started_at": "2022-10-12T15:09:35Z",
                    "status": "succeeded"
                },
                {
                    "credit_cost": 2,
                    "external_id": "542efe35-5ac9-4ad1-89c4-b1b06145fcb3",
                    "finished_at": "2022-10-12T15:09:52Z",
                    "id": "0ccea689-8bdc-4c14-8b24-024effeabe6e",
                    "name": "textfile_generator-new",
                    "started_at": "2022-10-12T15:09:37Z",
                    "status": "succeeded"
                },
                {
                    "credit_cost": 2,
                    "external_id": "74a3a1b5-1299-4315-aff8-a3af23b75fe9",
                    "finished_at": "2022-10-12T15:09:50Z",
                    "id": "8477150c-a9f9-407f-bce1-9544fcbbb050",
                    "name": "archive_generator",
                    "started_at": "2022-10-12T15:09:37Z",
                    "status": "succeeded"
                }]
            }]
  - BITRISE_APP_SLUG: b520099804d7e71a
  - BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET: $BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET

workflows:

  test_download_all_artifacts_of_build:
    before_run:
    - _setup
    - _cleanup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: .*
        - bitrise_api_base_url: https://api.bitrise.io
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - files: |-
            EXAMPLE_CSV
            EXPORT_OPTIONS_PLIST
            TEST_JSON
            TEXT_FILE_TXT
            ARCHIVE_TAR

  test_download_specific_stage_artifacts:
    before_run:
    - _setup
    - _cleanup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: stage-1-new\..*
        - bitrise_api_base_url: https://api.bitrise.io
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - files: |-
            TEXT_FILE_TXT

  _cleanup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            envman unset --key EXAMPLE_CSV
            envman unset --key EXPORT_OPTIONS_PLIST
            envman unset --key TEST_JSON
            envman unset --key TEXT_FILE_TXT

  _setup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex

            json_response=$(curl --fail -X POST https://auth.services.bitrise.io/auth/realms/bitrise-services/protocol/openid-connect/token -k \
                --data "client_id=artifact-pull" \
                --data "client_secret=$BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET" \
                --data "grant_type=urn:ietf:params:oauth:grant-type:uma-ticket" \
                --data "scope=build_artifact:read build:read app:read" \
                --data "claim_token=ewogICJidWlsZF9pZHMiOiBbCiAgICAiNmY0OWY1ZTItZTQ5OC00MDg4LWExMzktOTJlMTA5ZGE3YWJjIiwKICAgICI4MjU2NjRhYS0zZWM5LTRhNzUtOGMwMi0zMzQ1OWY4MmEyMzIiLAogICAgIjMyM2FhYjVjLTM5YjQtNGNkNS05NzRlLTdmZGRmNDdjZTY1ZSIsCiAgICAiNGNkNGI2ZDUtNzE0Ny00MzE1LWE5YmUtNGExZjhkNGJhYWU4IgogIF0sCiAgInBpcGVsaW5lX2lkIjogWwogICAgImMyMGEwNmM1LWRjYmUtNDMyYy04MjYxLTYzMzc4OWIwNzQwNiIKICBdCn0=" \
                --data "claim_token_format=urn:ietf:params:oauth:token-type:jwt" \
                --data "audience=bitrise-api")

            auth_token=$(echo $json_response | jq -r .access_token)

            envman add --key BITRISEIO_ARTIFACT_PULL_TOKEN --value $auth_token

    - script:
        title: Clean _tmp folder
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            rm -rf ./_artifact_pull
