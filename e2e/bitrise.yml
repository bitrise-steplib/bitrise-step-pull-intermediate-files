format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared envs for every test workflow
  - BITRISEIO_FINISHED_STAGES: |-
        [{
            "id": "996e8a18-947e-4bed-940d-c65e8439245f",
            "name": "stage-1-new",
            "workflows": [{
                "credit_cost": 2,
                "external_id": "2ffa98aa-92d8-456f-9ba4-4d1d6548cfb3",
                "finished_at": "2022-11-14T06:28:15Z",
                "id": "eab6d91a-b3ff-4744-9f2a-ac15b8acf3b2",
                "name": "placeholder",
                "started_at": "2022-11-14T06:28:14Z",
                "status": "succeeded"
            },
            {
                "credit_cost": 2,
                "external_id": "08c8cc72-e98d-47de-92a5-09b6bd7d55df",
                "finished_at": "2022-11-14T06:28:28Z",
                "id": "095f534e-d98c-41a8-9d0e-6959380ed039",
                "name": "textfile_generator-new",
                "started_at": "2022-11-14T06:28:14Z",
                "status": "succeeded"
            }]
        }, {
            "id": "3b5136b6-92c6-4576-aedc-9e21cba8432c",
            "name": "stage-2-new",
            "workflows": [{
                "credit_cost": null,
                "external_id": "00c49d06-d1d8-4ee9-a0ce-ee340228740d",
                "finished_at": "2022-11-14T06:29:14Z",
                "id": "48574051-24f6-4571-9aaa-d1589f7cece4",
                "name": "deployer-new",
                "started_at": "2022-11-14T06:28:58Z",
                "status": "succeeded"
            },
            {
                "credit_cost": 2,
                "external_id": "bb1d9f29-e85f-4ace-a4a7-592901eb9f61",
                "finished_at": "2022-11-14T06:28:43Z",
                "id": "b7cff818-bbbb-4372-9d0c-f800660408e8",
                "name": "textfile_generator-new",
                "started_at": "2022-11-14T06:28:30Z",
                "status": "succeeded"
            },
            {
                "credit_cost": 2,
                "external_id": "f2f498a1-c091-405c-9844-294938ba6339",
                "finished_at": "2022-11-14T06:28:43Z",
                "id": "74dd46a3-dc0b-43f2-9cb5-a3d4ffec0e83",
                "name": "archive_generator",
                "started_at": "2022-11-14T06:28:30Z",
                "status": "succeeded"
            }]
        }]
  - BITRISE_APP_SLUG: b520099804d7e71a
  - BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET: $BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET

workflows:

  test_download_all_artifacts_of_build:
    before_run:
    - _setup
    - _cleanup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: .*
        - bitrise_api_base_url: https://api.bitrise.io
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - files: |-
            EXAMPLE_CSV
            EXPORT_OPTIONS_PLIST
            TEST_JSON
            TEXT_FILE_TXT
        - dirs: |-
            ARCHIVE_ZIP

  test_download_specific_stage_artifacts:
    before_run:
    - _setup
    - _cleanup
    steps:
    - path::./:
        title: Execute step
        inputs:
        - verbose: true
        - artifact_sources: stage-1-new\..*
        - bitrise_api_base_url: https://api.bitrise.io
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        title: Validate downloaded artifacts
        is_always_run: true
        inputs:
        - files: |-
            TEXT_FILE_TXT

  _cleanup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            envman unset --key EXAMPLE_CSV
            envman unset --key EXPORT_OPTIONS_PLIST
            envman unset --key TEST_JSON
            envman unset --key TEXT_FILE_TXT

  _setup:
    steps:
    - script:
        title: Get access token
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex

            json_response=$(curl --fail -X POST https://auth.services.bitrise.io/auth/realms/bitrise-services/protocol/openid-connect/token -k \
                --data "client_id=artifact-pull" \
                --data "client_secret=$BITRISE_AUTH_SERVICE_ARTIFACT_PULL_CLIENT_SECRET" \
                --data "grant_type=urn:ietf:params:oauth:grant-type:uma-ticket" \
                --data "scope=build_artifact:read build:read app:read" \
                --data "claim_token=ewogICJidWlsZF9pZHMiOiBbCiAgICAiMmZmYTk4YWEtOTJkOC00NTZmLTliYTQtNGQxZDY1NDhjZmIzIiwKICAgICIwOGM4Y2M3Mi1lOThkLTQ3ZGUtOTJhNS0wOWI2YmQ3ZDU1ZGYiLAogICAgIjAwYzQ5ZDA2LWQxZDgtNGVlOS1hMGNlLWVlMzQwMjI4NzQwZCIsCiAgICAiYmIxZDlmMjktZTg1Zi00YWNlLWE0YTctNTkyOTAxZWI5ZjYxIiwKICAgICJmMmY0OThhMS1jMDkxLTQwNWMtOTg0NC0yOTQ5MzhiYTYzMzkiCiAgXSwKICAicGlwZWxpbmVfaWQiOiBbCiAgICAiMjg3ZWU1OGQtMmI3Ny00MDJhLWFhMWMtODM1ZGNjMGNlOTcwIgogIF0KfQ==" \
                --data "claim_token_format=urn:ietf:params:oauth:token-type:jwt" \
                --data "audience=bitrise-api")

            auth_token=$(echo $json_response | jq -r .access_token)

            envman add --key BITRISEIO_ARTIFACT_PULL_TOKEN --value $auth_token

    - script:
        title: Clean _tmp folder
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            rm -rf ./_artifact_pull
